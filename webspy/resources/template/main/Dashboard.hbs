<!doctype html>
<html lang="en">
{{> header}}
<body class="bg-black" data-bs-theme="dark">
{{> dashboard_navigation}}
<main style="padding-left: 300px;">
    <div id="main-content"></div>
    {{> footer}}
</main>
{{> scripts}}
<script>
    Chart.defaults.plugins.legend.position = 'bottom';
    Chart.defaults.plugins.legend.labels.color = 'white';
    Chart.defaults.plugins.title.display = false;

    let domainList, userList, uniqueUsersPerDomain, requestsList, endpointRequestFrequency, requestTotal, blockedRequestsDailyCount;

    init();

    function init(){
        refresh();
        //renderHomeOverview()
    }

    function refresh(){
        const contentFetch = fetch("/api/domain/all");
        const ipFetch = fetch("/api/ip/all");
        const requestFetch = fetch("/api/analytics/domain-requests");
        const uniqueIpsPerDomainFetch = fetch("/api/analytics/unique-ips-all-domains");
        const endpointRequestFrequencyFetch = fetch("/api/analytics/endpoint-requests");
        const requestTotalFetch = fetch("/api/analytics/request-total");
        const dailyBlockedFetch = fetch("/api/analytics/daily-blocked-requests");

        Promise.all([contentFetch, ipFetch, uniqueIpsPerDomainFetch, requestFetch, endpointRequestFrequencyFetch, requestTotalFetch, dailyBlockedFetch])
                .then(responses => {
                    const response1 = checkStatus(responses[0]);
                    const response2 = checkStatus(responses[1]);
                    const response3 = checkStatus(responses[2]);
                    const response4 = checkStatus(responses[3]);
                    const response5 = checkStatus(responses[4]);
                    const response6 = checkStatus(responses[5]);
                    const response7 = checkStatus(responses[6]);

                    return Promise.all([response1, response2, response3, response4, response5, response6, response7]);
                })
                .then(data => {
                    let response1 = data[0].json();
                    let response2 = data[1].json();
                    let response3 = data[2].json();
                    let response4 = data[3].json();
                    let response5 = data[4].json();
                    let response6 = data[5].json();
                    let response7 = data[6].json();

                    return Promise.all([response1, response2, response3, response4, response5, response6, response7]);
                })
                .then(data => {
                    domainList = data[0];
                    userList = data[1];
                    uniqueUsersPerDomain = data[2];
                    requestsList = data[3];
                    endpointRequestFrequency = data[4];
                    requestTotal = data[5];
                    blockedRequestsDailyCount = data[6];
                    populateNavBar();
                })
                .catch((response)=>{
                    console.log(response);
                    response.json()
                            .then(errorData => {
                                console.log(errorData);
                            })
                            .catch(error => {
                                console.error("Error parsing error response:", error);
                            });
                });
    }

    // Rendering functions
    function populateNavBar(){
        let container = document.querySelector("#nav-domain-container");
        let htmlContent = `<li><a onclick="" class="link-body-emphasis d-inline-flex text-decoration-none rounded">Overview</a></li>`;
        domainList.forEach((domain) => {
            let htmlDomain = `
                <li><a onclick="viewDomain('${domain.domain}')" class="link-body-emphasis d-inline-flex text-decoration-none rounded">${domain.name}</a></li>
            `;
            htmlContent+= htmlDomain;
        });
        htmlContent += `<li><a onclick="viewCreateDomain('')" class="link-body-emphasis d-inline-flex text-decoration-none rounded">Add Domain</a></li>`;
        container.innerHTML = htmlContent;
    }

    function renderHomeOverview(){
        const allDomainActivityFetch = fetch("/api/analytics/daily-requests");
        const allRequests = fetch("/api/report/all");

        Promise.all([allDomainActivityFetch, allRequests])
                .then(responses => {
                    const response1 = checkStatus(responses[0]);
                    const response2 = checkStatus(responses[1]);

                    return Promise.all([response1, response2]);
                })
                .then(data => {
                    let response1 = data[0].json();
                    let response2 = data[1].json();

                    return Promise.all([response1, response2]);
                })
                .then(data => {
                    let domainActivity = data[0];
                    let allRequests = data[1];

                    let requestFrequency = "";

                    for(let i = 0; i < endpointRequestFrequency.length && i < 7; i++){
                        requestFrequency += `<p class="mb-2" role="button" onclick="viewDomain('${endpointRequestFrequency[i][0]}')"><strong>${endpointRequestFrequency[i][3]}</strong>: ${createMethodBadge(endpointRequestFrequency[i][2])} ${endpointRequestFrequency[i][0] + endpointRequestFrequency[i][1]}</p>`;
                    }

                    let blockedDatasetCoordinates = [];
                    let totalBlockedRequests = 0;
                    blockedRequestsDailyCount.forEach((request) => {
                        blockedDatasetCoordinates.push({x: new Date(request[0]), y: request[1]});
                        totalBlockedRequests += request[1];
                    });

                    // Report table
                    let reportTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Access</th>
                                        <th scope="col">Timestamp</th>
                                        <th scope="col">User Agent</th>
                                        <th scope="col">url</th>
                                        <th scope="col">Method</th>
                                        <th scope="col">Header</th>
                                        <th scope="col">Protocol</th>
                                        <th scope="col">Locale</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                    allRequests.forEach((request) => {
                        reportTable += `
                            <tr>
                                <th scope="row" onclick="viewDomain('${request.domain_id}')" role="button">${request.domain_id}</th>
                                <td>${request.blocked? "<span class='badge text-bg-danger'>Denied</span>" : "<span class='badge text-bg-success'>Allow</span>"}</td>
                                <td>${formatDateTime(request.timestamp)}</td>
                                <td>${request.user_agent}</td>
                                <td>${request.request_url}</td>
                                <td>${createMethodBadge(request.request_method)}</td>
                                <td>${request.request_header}</td>
                                <td>${request.request_protocol}</td>
                                <td>${request.client_locale}</td>
                            </tr>
                            `;
                    });
                    reportTable += `</tbody></table>`;
                    console.log(allRequests[0]);

                    // Endpoint frequency table
                    let endpointTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Endpoint</th>
                                        <th scope="col">Method</th>
                                        <th scope="col">Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                    endpointRequestFrequency.forEach((request) => {
                        endpointTable += `
                            <tr>
                                <th scope="row" onclick="viewDomain('${request[0]}')" role="button">${request[0]}</th>
                                <td>${request[1]}</th>
                                <td>${createMethodBadge(request[2])}</td>
                                <td>${request[3]}</td>
                            </tr>
                            `;
                    });
                    endpointTable += `</tbody></table>`;

                    // Domain frequency table
                    let domainTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                    requestsList.forEach((request) => {
                        domainTable += `
                            <tr>
                                <th scope="row" onclick="viewDomain('${request[0]}')" role="button">${request[0]}</th>
                                <td>${request[1]}</td>
                            </tr>
                            `;
                    });
                    domainTable += `</tbody></table>`;

                    // User activity table
                    let userActivityTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Requests</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                    domainActivity.forEach((request) => {
                        userActivityTable += `
                            <tr>
                                <th scope="row" onclick="viewDomain('${request[1]}')" role="button">${request[1]}</th>
                                <td>${formatDateTime(request[0])}</th>
                                <td>${request[2]}</td>
                            </tr>
                            `;
                    });
                    userActivityTable += `</tbody></table>`;

                    let container = document.querySelector("#main-content");
                    container.innerHTML = `
                    <div class="d-flex justify-content-center align-items-end p-4 tiled-WS-background mb-3" style="position: relative;">
                        <h2 class="fw-bold fs-1">Traffic Overview</h2>
                    </div>
                    <div class="container-fluid">
                        <div class="row">
                            <div class="col-12 mb-3">
                                <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                    <h5 class="fw-bold text-center">All Domain Activity</h5>
                                    <canvas id="domain-activity-canvas"></canvas>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4 mb-3">
                                <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                    <h5 class="fw-bold text-center">Request Distribution</h5>
                                    <canvas id="request-per-domain-canvas"></canvas>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4 mb-3">
                                <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                    <h5 class="fw-bold text-center">Most Used Endpoints</h5>
                                    ${requestFrequency}
                                </div>
                            </div>
                            <div class="col-12 col-lg-4 mb-3">
                                <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                    <h5 class="fw-bold text-center">Total Requests</h5>
                                    <p class="fs-4 text-center">${requestTotal}</p>
                                    <h5 class="fw-bold text-center">Unique IP Addresses</h5>
                                    <p class="fs-4 text-center">${userList.length}</p>
                                    <h5 class="fw-bold text-center">Reporting Domains</h5>
                                    <p class="fs-4 text-center">${domainList.length}</p>
                                </div>
                            </div>
                            <div class="col-12 col-lg-4 mb-3">
                                <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                    <h5 class="fw-bold text-center">Blocked IP Addresses</h5>
                                    <p class="fs-4 text-center">4</p>
                                    <h5 class="fw-bold text-center">Blocked Requests</h5>
                                    <p class="fs-4 text-center">${totalBlockedRequests}</p>
                                </div>
                            </div>
                            <div class="col-12 col-lg-8 mb-3">
                                <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                    <h5 class="fw-bold text-center">Blocked Requests</h5>
                                    <canvas id="blocked-requests-canvas"></canvas>
                                </div>
                            </div>
                            <div class="col-12 mb-2">
                                <div class="py-3">
                                    <ul class="nav nav-underline" id="myTab" role="tablist">
                                      <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="request-by-date-tab" data-bs-toggle="tab" data-bs-target="#request-by-date-tab-pane" type="button" role="tab" aria-controls="request-by-date-tab-pane" aria-selected="true">All Requests</button>
                                      </li>
                                      <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="endpoint-frequency-tab" data-bs-toggle="tab" data-bs-target="#endpoint-frequency-tab-pane" type="button" role="tab" aria-controls="endpoint-frequency-tab-pane" aria-selected="false">Endpoint Frequency</button>
                                      </li>
                                      <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="domain-frequency-tab" data-bs-toggle="tab" data-bs-target="#domain-frequency-tab-pane" type="button" role="tab" aria-controls="domain-frequency-tab-pane" aria-selected="false">Total Domain Frequency</button>
                                      </li>
                                      <li class="nav-item" role="presentation">
                                          <button class="nav-link" id="daily-domain-frequency-tab" data-bs-toggle="tab" data-bs-target="#daily-domain-frequency-tab-pane" type="button" role="tab" aria-controls="daily-domain-frequency-tab-pane" aria-selected="false">Daily Domain Frequency</button>
                                      </li>
                                    </ul>
                                    <div class="tab-content" id="myTabContent">
                                      <div class="tab-pane fade show overflow-auto active" id="request-by-date-tab-pane" role="tabpanel" aria-labelledby="request-by-date-tab" tabindex="0">${reportTable}</div>
                                      <div class="tab-pane overflow-auto fade" id="endpoint-frequency-tab-pane" role="tabpanel" aria-labelledby="endpoint-frequency-tab" tabindex="0">${endpointTable}</div>
                                      <div class="tab-pane overflow-auto fade" id="domain-frequency-tab-pane" role="tabpanel" aria-labelledby="domain-frequency-tab" tabindex="0">${domainTable}</div>
                                      <div class="tab-pane overflow-auto fade" id="daily-domain-frequency-tab-pane" role="tabpanel" aria-labelledby="daily-domain-frequency-tab" tabindex="0">${userActivityTable}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;

                    let activityDatasets = [];
                    let domains = domainList.map(domain => domain.domain);

                    let dailyDomainFrequencyDatasets = domains.map(domain => {
                        let usageData = domainActivity
                          .filter(day => domain === day[1])
                          .map(day => ({
                            x: new Date(day[0]),
                            y: day[2]
                          }));
                        console.log("domain:" + domain + " data: " + usageData);
                        return {
                            label: domain,
                            data: usageData
                        }
                    });

                    let domainActivityCanvas = document.querySelector("#domain-activity-canvas");
                    let activityChart = new Chart(domainActivityCanvas, {
                        type:'line',
                        data:{
                            datasets: dailyDomainFrequencyDatasets
                        },
                        options: {
                            aspectRatio: 4,
                            scales: {
                                x: {
                                    type: 'time',
                                    time:{
                                        unit: 'day',
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    stepSize: 1
                                }
                            }
                        }
                    });

                    let rdcDomains = [];
                    let domainRequestCount = [];

                    requestsList.forEach((domain) => {
                        rdcDomains.push(domain[0]);
                        domainRequestCount.push(domain[1]);
                    });

                    let requestDistributionCanvas = document.querySelector("#request-per-domain-canvas");
                    let domainChart = new Chart(requestDistributionCanvas, {
                        type:'doughnut',
                        data:{
                            labels:rdcDomains,
                            datasets:[{
                                label:'Requests',
                                data:domainRequestCount
                            }]
                        },
                        options:{}
                    });

                    let blockedDataset = [{label: "rat", data: blockedDatasetCoordinates}];
                    let blockedRequestsCanvas = document.querySelector("#blocked-requests-canvas");
                    let blockedRequestChart = new Chart(blockedRequestsCanvas, {
                        type:'line',
                        data:{
                            datasets: blockedDataset
                        },
                        options: {
                            aspectRatio: 2,
                            plugins: {
                                legend: {
                                    display: false // Hide the legend
                                }
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time:{
                                        unit: 'day',
                                    }
                                },
                                y: {
                                    beginAtZero: true,
                                    stepSize: 1
                                }
                            }
                        }
                    });
                })
                .catch((response)=>{
                    console.log(response);
                    response.json()
                            .then(errorData => {
                                console.log(errorData);
                            })
                            .catch(error => {
                                console.error("Error parsing error response:", error);
                            });
                });
    }

    function viewDomain(domainId){
        let container = document.querySelector("#main-content");

        let domain = domainLookup(domainId);

        console.log(domain)
        if(domain.domain == null){
            // domain not found
            viewCreateDomain("Domain not found");
        }else{
            Promise.all([fetch('/api/report/domain/' + domain.domain)])
                    .then(responses => {
                        const response1 = checkStatus(responses[0]);

                        return Promise.all([response1]);
                    })
                    .then(data => {
                        let response1 = data[0].json();

                        return Promise.all([response1]);
                    })
                    .then(data => {
                        let allReports = data[0];


                        container.innerHTML = `
                        <div class="d-flex justify-content-center align-items-end p-4 tiled-WS-background mb-3" style="position: relative;">
                            <h2 class="fw-bold fs-1">${domain.name}</h2>
                        </div>
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h5 class="fw-bold text-center">Domain Activity</h5>
                                        <canvas id="domain-activity-canvas"></canvas>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h4 class="fw-bold text-center">Most Active IP Addresses</h4>
                                        <p class="fs-4 text-center mb-0">Poopsie</p>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h5 class="fw-bold text-center">Unique IP Addresses</h5>
                                        <p class="fs-4 text-center mb-0">${uniqueUsersPerDomainLookup(domain.domain)}</p>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h5 class="fw-bold text-center">Most Active Country</h5>
                                        <p class="fs-4 text-center mb-0">poop</p>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h4 class="fw-bold text-center">Blocked Requests</h4>

                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h5 class="fw-bold text-center">Top Endpoints</h5>
                                        <p class="fs-4 text-center mb-0">w costi</p>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h5 class="fw-bold text-center">Browser Distribution</h5>

                                    </div>
                                </div>

                                <div class="col-12 mb-2">
                                    <div class="py-3">
                                        <ul class="nav nav-underline" id="myTab" role="tablist">
                                          <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="request-by-date-tab" data-bs-toggle="tab" data-bs-target="#request-by-date-tab-pane" type="button" role="tab" aria-controls="request-by-date-tab-pane" aria-selected="true">All Requests</button>
                                          </li>
                                          <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="endpoint-frequency-tab" data-bs-toggle="tab" data-bs-target="#endpoint-frequency-tab-pane" type="button" role="tab" aria-controls="endpoint-frequency-tab-pane" aria-selected="false">Endpoint Frequency</button>
                                          </li>
                                          <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="domain-frequency-tab" data-bs-toggle="tab" data-bs-target="#domain-frequency-tab-pane" type="button" role="tab" aria-controls="domain-frequency-tab-pane" aria-selected="false">Total Domain Frequency</button>
                                          </li>
                                          <li class="nav-item" role="presentation">
                                              <button class="nav-link" id="daily-domain-frequency-tab" data-bs-toggle="tab" data-bs-target="#daily-domain-frequency-tab-pane" type="button" role="tab" aria-controls="daily-domain-frequency-tab-pane" aria-selected="false">Daily Domain Frequency</button>
                                          </li>
                                        </ul>
                                        <div class="tab-content" id="myTabContent">
                                          <div class="tab-pane fade show overflow-auto active" id="request-by-date-tab-pane" role="tabpanel" aria-labelledby="request-by-date-tab" tabindex="0"></div>
                                          <div class="tab-pane overflow-auto fade" id="endpoint-frequency-tab-pane" role="tabpanel" aria-labelledby="endpoint-frequency-tab" tabindex="0"></div>
                                          <div class="tab-pane overflow-auto fade" id="domain-frequency-tab-pane" role="tabpanel" aria-labelledby="domain-frequency-tab" tabindex="0"></div>
                                          <div class="tab-pane overflow-auto fade" id="daily-domain-frequency-tab-pane" role="tabpanel" aria-labelledby="daily-domain-frequency-tab" tabindex="0"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;

                        let activityCanvas = document.querySelector("#domain-activity-canvas");
                        let activityChart = new Chart(activityCanvas, {
                            type:'line',
                            data:{
                                datasets: dailyDomainFrequencyDatasets
                            },
                            options: {
                                scales: {
                                    x: {
                                        type: 'time',
                                        time:{
                                            unit: 'day',
                                        }
                                    }
                                }
                            }
                        });
                    });
        }
    }

    function renderAllUsers(){
        let container = document.querySelector("#main-content");
        let htmlContent = `
            <div class="d-flex justify-content-center align-items-end p-4 tiled-WS-background mb-3" style="position: relative;">
                <h2 class="fw-bold fs-1">All IP Addresses</h2>
            </div>
            <div class="container-fluid">
                <p class="fs-4">Ordered ${userList.length} addresses by date discovered</p>
                <div class="row row-cols-1 row-cols-md-3 row cols-lg-4">
        `;
        userList.forEach((user) => {
            let htmlDomain = `
                <div class="col mb-4">
                    <div class="px-3 py-3 rounded-3 ${hasAlreadyPassed(user.expire)? "bg-dark" : "alert alert-danger"}" onclick="viewUser('${user.ip}')">
                        <h3>${user.ip}</h3>
                        <p class="mb-0">${user.nickname !== 'null' ? "No Name" : user.nickname} &#8226; ${createBadge(user.threat_level)}</p>
                        ${hasAlreadyPassed(user.expire)? "<p>Access Accepted</p>" : "<p>Access Denied</p>"}
                    </div>
                </div>
            `;
            htmlContent+= htmlDomain;
        });
        htmlContent += `</div></div>`;
        container.innerHTML = htmlContent;
    }

    function viewCreateDomain(message='', success=true){
        let container = document.querySelector("#main-content");

        let alert = "";
        if(!success){
            alert = `<div class='alert alert-danger alert-dismissible fade show mt-3'>${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        }else if(message !== ""){
            alert = `<div class='alert alert-success alert-dismissible fade show mt-3'>${message}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>`;
        }

        let htmlContent =`
        <div class="d-flex justify-content-center align-items-end p-4 tiled-WS-background mb-3" style="position: relative;">
            <h2 class="fw-bold fs-1">Add New Domain</h2>
        </div>
        <div class="container-fluid" style="margin-top: 100px; margin-bottom: 100px;">
            <div class="row">
                <div class="col-md-6 offset-md-3 p-4">
                    <h2 class="fw-bold text-center mb-2">Enter Domain Information</h2>
                    ${alert}
                    <label for="domain-name-form" class="form-label">Domain Nickname</label>
                    <input class="form-control form-control-lg mb-3" id="domain-name-form" type="text" placeholder="Costi Online">

                    <label for="domain-form" class="form-label">Domain</label>
                    <input class="form-control form-control-lg" id="domain-form" type="text" placeholder="costionline.com" aria-describedby="domain-form-helper">
                    <div id="domain-form-helper" class="form-text">Domain must be exact</div>
                    <button class="btn btn-primary mb-3 mt-3" onclick="newDomain()">Add Domain</button>
                </div>
            </div>
        </div>
        `;
        container.innerHTML = htmlContent;
    }

    function viewUser(ip, err=""){
        let container = document.querySelector("#main-content");
        if(ip===""){
            container.innerHTML = `
            <div class="d-flex justify-content-center align-items-end p-4 tiled-WS-background mb-3" style="position: relative;">
                <h2 class="fw-bold fs-1">IP Address Details</h2>
            </div>
            <div class="container-fluid" style="margin-top: 100px; margin-bottom: 100px;">
                <div class="row">
                    <div class="col-md-6 offset-md-3 p-4">
                        <h2 class="fw-bold text-center mb-2">IP lookup</h2>
                        ${err != ""? `<div class='alert alert-danger alert-dismissible fade show'>${err}<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>` : ""}
                        <label for="user-lookup-form" class="form-label">IP address</label>
                        <input class="form-control form-control-lg" id="user-lookup-form" type="text" placeholder="192.168.0.1" aria-describedby="ipHelper">
                        <div id="ipHelper" class="form-text">ID must be exact</div>
                        <button class="btn btn-primary mb-3 mt-3" onclick="searchUserButton()">Search IP</button>
                    </div>
                </div>
            </div>

            `;
        }else{
            // Check to see if user exists
            let user = userLookup(ip);

            if(user === undefined || user == null){
                // User not found
                viewUser('', "IP Address not found");
            }

            // Query database for reports
            Promise.all([fetch('/api/report/ip/' + ip), fetch('/api/analytics/endpoint-requests/' + ip), fetch('/api/analytics/domain-requests/' + ip), fetch('/api/analytics/daily-requests-by-domain/' + ip)])
                    .then(responses => {
                        const response1 = checkStatus(responses[0]);
                        const response2 = checkStatus(responses[1]);
                        const response3 = checkStatus(responses[2]);
                        const response4 = checkStatus(responses[3]);

                        return Promise.all([response1, response2, response3, response4]);
                    })
                    .then(data => {
                        let response1 = data[0].json();
                        let response2 = data[1].json();
                        let response3 = data[2].json();
                        let response4 = data[3].json();

                        return Promise.all([response1, response2, response3, response4]);
                    })
                    .then(data => {
                        let userReports = data[0];
                        let requestFrequency = data[1];
                        let domainFrequency = data[2];
                        let dailyDomainFrequency = data[3];
                        let lastSeen = userReports.length === 0? `N/A` : formatDate(userReports[0].timestamp);
                        let firstSeen = formatDate(user.first_seen);
                        let numBlocked = 0;
                        let topEndpoints = "";
                        for(let i = 0; i < requestFrequency.length && i < 7; i++){
                            topEndpoints += `<p class="mb-2"><strong>${requestFrequency[i][3]}</strong>: ${createMethodBadge(requestFrequency[i][2])} ${requestFrequency[i][1]}</p>`;
                        }

                        // Report table
                        let reportTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Access</th>
                                        <th scope="col">Timestamp</th>
                                        <th scope="col">User Agent</th>
                                        <th scope="col">url</th>
                                        <th scope="col">Method</th>
                                        <th scope="col">Header</th>
                                        <th scope="col">Protocol</th>
                                        <th scope="col">Locale</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        userReports.forEach((request) => {
                            reportTable += `
                            <tr>
                                <th scope="row">${request.domain_id}</th>
                                <td>${request.blocked? "<span class='badge text-bg-danger'>Denied</span>" : "<span class='badge text-bg-success'>Allow</span>"}</td>
                                <td>${formatDateTime(request.timestamp)}</td>
                                <td>${request.user_agent}</td>
                                <td>${request.request_url}</td>
                                <td>${createMethodBadge(request.request_method)}</td>
                                <td>${request.request_header}</td>
                                <td>${request.request_protocol}</td>
                                <td>${request.client_locale}</td>
                            </tr>
                            `;
                            if(request.blocked){
                                numBlocked++;
                            }
                        });
                        reportTable += `</tbody></table>`;

                        // Endpoint frequency table
                        let endpointTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Endpoint</th>
                                        <th scope="col">Method</th>
                                        <th scope="col">Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        requestFrequency.forEach((request) => {
                            endpointTable += `
                            <tr>
                                <th scope="row">${request[0]}</th>
                                <td>${request[1]}</th>
                                <td>${createMethodBadge(request[2])}</td>
                                <td>${request[3]}</td>
                            </tr>
                            `;
                        });
                        endpointTable += `</tbody></table>`;


                        // Domain frequency table
                        let domainTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Frequency</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        domainFrequency.forEach((request) => {
                            domainTable += `
                            <tr>
                                <th scope="row">${request[0]}</th>
                                <td>${request[1]}</td>
                            </tr>
                            `;
                        });
                        domainTable += `</tbody></table>`;

                        // User activity table
                        let userActivityTable = `
                            <table class="table table-dark table-striped table-responsive">
                                <thead class="table-dark">
                                    <tr>
                                        <th scope="col">Domain</th>
                                        <th scope="col">Date</th>
                                        <th scope="col">Requests</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        dailyDomainFrequency.forEach((request) => {
                            userActivityTable += `
                            <tr>
                                <th scope="row">${request[0]}</th>
                                <td>${formatDateTime(request[1])}</th>
                                <td>${request[2]}</td>
                            </tr>
                            `;
                        });
                        userActivityTable += `</tbody></table>`;

                        // OS and Browser icons
                        let osIcon = "N/A";
                        if(userReports.length > 0){
                            if (userReports[userReports.length-1].user_agent.includes("Windows")) {
                                osIcon = `<img class="browser-icon" src="/static/icons/Windows.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("mac")) {
                                osIcon = `<img class="browser-icon" src="/static/icons/MacOS.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("linux")) {
                                osIcon = `<img class="browser-icon" src="/static/icons/Linux.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("ios")) {
                                osIcon = `<img class="browser-icon" src="/static/icons/iOS.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("android")) {
                                osIcon = `<img class="browser-icon" src="/static/icons/Android.svg" />`;
                            }
                        }

                        let browser = "N/A";
                        if(userReports.length > 0){
                            if (userReports[userReports.length-1].user_agent.includes("Chrome")) {
                                browser = `<img class="browser-icon" src="/static/icons/Chrome.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("Safari")) {
                                browser = `<img class="browser-icon" src="/static/icons/Safari.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("Firefox")) {
                                browser = `<img class="browser-icon" src="/static/icons/Firefox.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("Edge")) {
                                browser = `<img class="browser-icon" src="/static/icons/Edge.svg" />`;
                            } else if (userReports[userReports.length-1].user_agent.includes("Opera")) {
                                browser = `<img class="browser-icon" src="/static/icons/Opera.svg" />`;
                            }
                        }

                        container.innerHTML = `
                        <div class="d-flex justify-content-center align-items-end p-4 tiled-WS-background mb-3" style="position: relative;">
                            <h2 class="fw-bold fs-1">IP Address Details</h2>
                        </div>
                        <div class="container-fluid">
                            <div class="row">
                                <div class="col-12 mb-2 d-flex align-items-center justify-content-between">
                                    <div><a class="text-secondary fs-4" onclick="renderAllUsers()">&lt; All IP Addresses</a></div>
                                    <div><a class="text-secondary fs-4" onclick="viewUser('${user.ip}')">Refresh</a></div>
                                    <div>
                                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editUserModal">
                                          Edit IP
                                        </button>
                                    </div>
                                </div>

                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h1 class="text-center fw-bold">${user.ip}</h1>
                                        <h5 class="text-center fw-bold mb-5">${user.nickname !== 'null' ? "No name" : user.nickname}</h5>
                                        <p class="text-center fs-4">${createBadge(user.threat_level)}</p>
                                        <p class="fw-bold text-center fs-4">Total Requests: ${userReports.length}</p>
                                    </div>
                                </div>
                                <div class="col-lg-8 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h4 class="fw-bold text-center">IP Address Requests</h4>
                                        <canvas id="activity-chart"></canvas>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark dual-info-box h-100">
                                        <div>
                                            <h5 class="fw-bold text-center">First Seen</h5>
                                            <p class="fs-4 text-center mb-0">${firstSeen}</p>

                                            <h5 class="fw-bold text-center mt-4">Browser</h5>
                                            <p class="fs-4 text-center mb-0 mt-3">${browser}</p>
                                        </div>
                                        <div>
                                            <h5 class="fw-bold text-center">Last Seen</h5>
                                            <p class="fs-4 text-center mb-0">${lastSeen}</p>

                                            <h5 class="fw-bold text-center mt-4">OS</h5>
                                            <p class="fs-4 text-center mb-0 mt-3">${osIcon}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h5 class="fw-bold text-center">Top Endpoints</h5>
                                        ${topEndpoints}
                                    </div>
                                </div>
                                <div class="col-lg-4 col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 bg-dark h-100">
                                        <h5 class="fw-bold text-center mb-2">Domain Activity</h5>
                                        <canvas id="domain-chart"></canvas>
                                    </div>
                                </div>
                                <div class="col-12 mb-3">
                                    <div class="px-3 py-3 rounded-3 d-flex align-items-center justify-content-between ${hasAlreadyPassed(user.expire)? "bg-dark" : "alert alert-danger"}">
                                        <div>
                                            <h2 class="fw-bold">Conditional Access</h2>
                                        </div>
                                        <div>${hasAlreadyPassed(user.expire)? "<h2>Traffic Allowed</h2>" : "<h5 class='text-center fw-bold'>Blocked Requests</h5><p class='fs-3 mb-0 text-center'>" + numBlocked + "</p>"}</div>
                                        ${hasAlreadyPassed(user.expire)? "" : "<div>" + user.reason + "</div>"}
                                    </div>
                                </div>
                                <div class="col-12 mb-2">
                                    <div class="py-3">
                                        <ul class="nav nav-underline" id="myTab" role="tablist">
                                          <li class="nav-item" role="presentation">
                                            <button class="nav-link active" id="request-by-date-tab" data-bs-toggle="tab" data-bs-target="#request-by-date-tab-pane" type="button" role="tab" aria-controls="request-by-date-tab-pane" aria-selected="true">All Requests</button>
                                          </li>
                                          <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="endpoint-frequency-tab" data-bs-toggle="tab" data-bs-target="#endpoint-frequency-tab-pane" type="button" role="tab" aria-controls="endpoint-frequency-tab-pane" aria-selected="false">Endpoint Frequency</button>
                                          </li>
                                          <li class="nav-item" role="presentation">
                                            <button class="nav-link" id="domain-frequency-tab" data-bs-toggle="tab" data-bs-target="#domain-frequency-tab-pane" type="button" role="tab" aria-controls="domain-frequency-tab-pane" aria-selected="false">Total Domain Frequency</button>
                                          </li>
                                          <li class="nav-item" role="presentation">
                                              <button class="nav-link" id="daily-domain-frequency-tab" data-bs-toggle="tab" data-bs-target="#daily-domain-frequency-tab-pane" type="button" role="tab" aria-controls="daily-domain-frequency-tab-pane" aria-selected="false">Daily Domain Frequency</button>
                                          </li>
                                        </ul>
                                        <div class="tab-content" id="myTabContent">
                                          <div class="tab-pane fade show overflow-auto active" id="request-by-date-tab-pane" role="tabpanel" aria-labelledby="request-by-date-tab" tabindex="0">${reportTable}</div>
                                          <div class="tab-pane overflow-auto fade" id="endpoint-frequency-tab-pane" role="tabpanel" aria-labelledby="endpoint-frequency-tab" tabindex="0">${endpointTable}</div>
                                          <div class="tab-pane overflow-auto fade" id="domain-frequency-tab-pane" role="tabpanel" aria-labelledby="domain-frequency-tab" tabindex="0">${domainTable}</div>
                                          <div class="tab-pane overflow-auto fade" id="daily-domain-frequency-tab-pane" role="tabpanel" aria-labelledby="daily-domain-frequency-tab" tabindex="0">${userActivityTable}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Edit IP Address Details</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                        <div class="modal-body">
                                            <div class="row">
                                                <div class="col-12 mb-3">
                                                    <label for="nicknameInput" class="form-label">Nickname</label>
                                                    <input type="text" class="form-control" id="nicknameInput">
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <label for="threatLevel" class="form-label">IP Address Access</label>
                                                        <select class="form-select" id="threatLevel">
                                                            <option value="none" selected>Keep the same</option>
                                                            <option value="delete">Remove Ban</option>
                                                            <option value="week-1">Ban 1 week</option>
                                                            <option value="month-1">Ban 1 month</option>
                                                            <option value="month-6">Ban 6 months</option>
                                                            <option value="year-1">Ban 1 year</option>
                                                            <option value="year-2">Ban 2 years</option>
                                                            <option value="year-100">Ban 100 years</option>
                                                        </select>
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <label for="threatLevel" class="form-label">Threat Level</label>
                                                    <select class="form-select" id="threatLevel">
                                                        <option selected>Choose threat level</option>
                                                        <option value="3">Not Assessed</option>
                                                        <option value="2">Normal</option>
                                                        <option value="1">Suspicious</option>
                                                        <option value="0">Threat</option>
                                                    </select>
                                                </div>
                                                <div class="col-12 mb-3">
                                                    <label for="banReason" class="form-label">Ban Reason</label>
                                                    <textarea class="form-control" id="banReason" rows="3"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary">Save changes</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                        // Chart data
                        let domainList = [];
                        let domainRequestCount = [];

                        domainFrequency.forEach((domain) => {
                            domainList.push(domain[0]);
                            domainRequestCount.push(domain[1]);
                        });

                        let dailyDomainFrequencyDatasets = domainList.map(domain => {
                            let usageData = dailyDomainFrequency
                                .filter(day => day[0] === domain)
                                .map(day => ({
                                x: new Date(day[1]),
                                y: day[2]
                            }));

                            return {
                                label: domain,
                                data: usageData
                            }
                        });


                        let activityCanvas = document.querySelector("#activity-chart");
                        let domainCanvas = document.querySelector("#domain-chart");

                        let activityChart = new Chart(activityCanvas, {
                            type:'line',
                            data:{
                                datasets: dailyDomainFrequencyDatasets
                            },
                            options: {
                                scales: {
                                    x: {
                                        type: 'time',
                                        time:{
                                            unit: 'day',
                                        }
                                    },
                                    y: {
                                        beginAtZero: true,
                                        stepSize: 1
                                    }
                                }
                            }
                        });

                        let domainChart = new Chart(domainCanvas, {
                            type:'doughnut',
                            data:{
                                labels:domainList,
                                datasets:[{
                                    label:'Requests',
                                    data:domainRequestCount
                                }]
                            },
                            options:{}
                        });
                    })
                    .catch((response)=>{
                        console.log(response);
                        response.json()
                                .then(errorData => {
                                    console.log(errorData);
                                })
                                .catch(error => {
                                    console.error("Error parsing error response:", error);
                                });
                    });
        }
    }

    function searchUserButton(){
        let ip = document.querySelector("#user-lookup-form").value;
        viewUser(ip);
    }
</script>

<script>
    // Functions that write to database

    function newDomain(){
        let domainData = {
            "name":document.querySelector("#domain-name-form").value,
            "url": document.querySelector("#domain-form").value
        };

        let headers = new Headers();
        headers.append('Content-Type', 'application/json');

        let options = {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(domainData)
        };

        fetch("/api/domain/new", options)
                .then(checkStatus)
                .then(response => response.json())
                .then(usableResponse => {
                    refresh();
                    console.log(usableResponse);
                    viewCreateDomain(usableResponse.message, usableResponse.success);
                });
    }
</script>

<script>
    const createBadge = (status) => {
        let badgeClass = '';
        switch (status) {
            case 'Threat':
                badgeClass = 'badge text-bg-danger';
                break;
            case 'Suspicious':
                badgeClass = 'badge text-bg-warning';
                break;
            case 'Normal':
                badgeClass = 'badge text-bg-success';
                break;
            case 'NotAssessed':
                badgeClass = 'badge text-bg-secondary';
                break;
            default:
                badgeClass = 'badge text-bg-secondary';
                break;
        }
        return `<span class="${badgeClass}">${status}</span>`;
    };
    const createMethodBadge = (status) => {
            let badgeClass = '';
            switch (status) {
                case 'GET':
                    badgeClass = 'badge text-bg-info';
                    break;
                case 'POST':
                    badgeClass = 'badge text-bg-warning';
                    break;
                default:
                    badgeClass = 'badge text-bg-secondary';
                    break;
            }
            return `<span class="${badgeClass}">${status}</span>`;
        };
    function userLookup(ip){
        return userList.find(user => user.ip === ip);
    }
    function domainLookup(domain_id){
        return domainList.find(domain => domain.domain === domain_id);
    }
    function uniqueUsersPerDomainLookup(domain_id){
        return uniqueUsersPerDomain.find(stat => stat[0] === domain_id)[1];
    }
    function formatDate(dateString) {
        const date = new Date(dateString);
        const mm = String(date.getMonth() + 1).padStart(2, '0');
        const dd = String(date.getDate()).padStart(2, '0');
        const yyyy = date.getFullYear();
        return `${mm}/${dd}/${yyyy}`;
    }
    function formatDateTime(dateTimeString) {
        const dateTime = new Date(dateTimeString);
        const mm = String(dateTime.getMonth() + 1).padStart(2, '0');
        const dd = String(dateTime.getDate()).padStart(2, '0');
        const yyyy = dateTime.getFullYear();
        const hours = String(dateTime.getHours()).padStart(2, '0');
        const minutes = String(dateTime.getMinutes()).padStart(2, '0');
        const seconds = String(dateTime.getSeconds()).padStart(2, '0');
        return `${mm}/${dd}/${yyyy} ${hours}:${minutes}:${seconds}`;
    }
    function hasAlreadyPassed(dateTimeString) {
        // Convert the input date and time string to a Date object
        const inputDate = new Date(dateTimeString);

        // Get the current date and time
        const currentDate = new Date();

        // Compare the input date with the current date
        return inputDate < currentDate;
    }
</script>
</body>
</html>